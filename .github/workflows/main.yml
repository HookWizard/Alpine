name: Setup Tailscale and GitHub Server

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl gnupg apt-transport-https

      - name: Add Tailscale repository
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list

      - name: Install Tailscale
        run: |
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Start and authenticate Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=github-runner --accept-routes
          echo "Tailscale IP:"
          sudo tailscale ip -4

      - name: Create user Alpine
        run: |
          sudo useradd -m Alpine
          echo "Alpine:$(openssl rand -base64 12)" | sudo chpasswd
          echo "Created user Alpine with a random password."

      - name: Download GitHub Enterprise Server
        run: |
          mkdir -p ~/downloads
          cd ~/downloads
          echo "Downloading GitHub Enterprise Server..."
          wget https://enterprise.github.com/releases/latest/download/github-enterprise-server.ova -O github-server.ova || echo "Download URL may need manual update."

      - name: Show Tailscale IP
        run: |
          echo "Tailscale IPv4 Address:"
          sudo tailscale ip -4
