name: Alpine Server

on:
  workflow_dispatch:

jobs:
  alpine-server:
    runs-on: ubuntu-20.04
    timeout-minutes: 3600

    steps:
      - name: Create user Alpine with secure password
        id: create_user
        run: |
          # Generate a secure random password
          PASSWORD=$(tr -dc 'A-Za-z0-9@#%+=_' </dev/urandom | head -c 16)
          
          # Create user Alpine
          sudo useradd -m -s /bin/bash Alpine
          echo "Alpine:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo Alpine
          
          echo "ALPINE_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "✅ Created user Alpine with a random secure password."

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl gnupg apt-transport-https wget

      - name: Add Tailscale repository
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg | \
            sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale-keyring.list | \
            sudo tee /etc/apt/sources.list.d/tailscale.list

      - name: Install Tailscale
        run: |
          sudo apt-get update
          sudo apt-get install -y tailscale
          sudo systemctl enable --now tailscaled

      - name: Authenticate Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=alpine-runner-${GITHUB_RUN_ID} --accept-routes
          echo "Tailscale connected."

      - name: Get Tailscale IP
        id: tailscale_ip
        run: |
          TS_IP=$(sudo tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "✅ Tailscale IPv4: $TS_IP"

      - name: Download GitHub Enterprise Server
        run: |
          mkdir -p ~/downloads
          cd ~/downloads
          echo "Downloading GitHub Enterprise Server..."
          wget https://enterprise.github.com/releases/latest/download/github-enterprise-server.ova -O github-server.ova || \
            echo "⚠️ Download URL may need manual update."
          ls -lh

      - name: Show access info
        run: |
          echo ""
          echo "======================================"
          echo "✅ Alpine Server Setup Complete"
          echo "--------------------------------------"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Username: Alpine"
          echo "Password: $ALPINE_PASS"
          echo "======================================"
          echo ""

      - name: Keep session alive
        run: |
          echo "Keeping GitHub Actions runner active for RDP or SSH via Tailscale..."
          while true; do
            echo "[$(date)] Runner active — press cancel in Actions to stop."
            sleep 300
          done
